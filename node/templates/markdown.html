<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="author" content="">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">
  
</head>

<body>
  <div class="main">
  		<div style="width:45%; height: 60vh; display: inline-block;">
	  		<textarea rows="20" id="inline-rules" style="width: 100%"></textarea>
	  		<button onclick="rulesChange()">Submit</button>
	  	</div>
	  	<div style="width:45%; height: 60vh; border: 1px solid black; display: inline-block;">
	  		
	  	</div>
  </div>
  <!--
  <textarea id="inline-rules"></textarea>
  <button onclick="rulesChange()">Submit</button>
  
  
  <input type="text" id="inline-math"></input>
  <div id="output-math"></div>	
  
  <input type="text" id="inline-graph"></input>
  <button onclick="plotChange()">Submit</button>
  <div id="output-graph"></div>	-->
  
	
  <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
  <script src="js/autosize.js"></script>
  <script src="js/marked.js"></script>
  <!--<script src="mathdocs/markdown-it-math.js"></script>-->
  <script>
  	autosize(document.getElementById('inline-rules'));
  	
  	
  	// Override function
	const tokenizer = {
	  inlineText(src) {
		const match = src.match(/\$+([^\$\n]+?)\$+/);
		if (match && match.index == 0) {
			console.log("matched math");
			console.log(match);
			console.log(src);
		  return {
			type: 'text',
			raw: match[0],
			text: "$|$"+match[1].trim()
		  };
		}
		else if (match) {
			console.log("matched line");
			console.log(match);
			console.log(src);
		  return {
			type: 'text',
			raw: match[0],
			text: src.substr(0,match.index)
		  };
		}
		// return false to use original inlineText tokenizer
		return false;
	  }
	};
	const renderer = {
	  text(text) {
		//const escapedText = text.toLowerCase().replace(/[^\w]+/g, '-');
		if (text.substr(0,3) == "$|$"){
			console.log("render math",text);
		}
		
		return `${text}`;
	  }
	};

	marked.use({ tokenizer });
	marked.use({ renderer });
	
	console.log(marked("this is $ x^12 $\n and no math"));
  	var myWorker = new Worker('js/wasmworker.js');
  	
  	myWorker.onmessage = function(e) {
		if (e.data[0] == "latex"){
			if (autoNow == e.data[1]){
				var latex = e.data[2];
				var html = katex.renderToString(latex, {throwOnError: false});
  				autoComplete[e.data[1]] = html;
  				chgAuto(e.data[1]);
			}
			else {
				var latex = e.data[2];
				var html = katex.renderToString(latex, {throwOnError: false});
  				autoComplete[e.data[1]] = html;
			}
		}
		else if (e.data[0] == "svg"){
			//if (autoNow == e.data[1]){
				var svg = e.data[2];
				document.getElementById("output-graph").innerHTML = svg;
				document.getElementById("domainSlider").addEventListener('change',plotChange);
			//}
			//else {
			//	var latex = e.data[2];
			//	var html = katex.renderToString(latex, {throwOnError: false});
  			//	autoComplete[e.data[1]] = html;
			//}
		}
		else if (e.data[0] == "rules"){
			console.log(e.data[1]);
		}
	}

  	function chgAuto(input) {
		var el = document.getElementById('output-math');
		el.innerHTML = autoComplete[input];
	}
  	function answerDown(evt) {
		var key = evt.key;
		if (key != 'Shift'){
			var answer = document.getElementById("inline-math").value;
			autoComplete[answer+key] = "in-progress";
			myWorker.postMessage(["latex",answer+key]);
		}
		
	}
	function answerChange(evt) {
		var answer = document.getElementById("inline-math").value;
		if (autoComplete[answer] == "in-progress"){
			autoNow = answer;
		}
		else if (autoComplete[answer]){
			chgAuto(answer);
		}
		else {
			myWorker.postMessage(["latex",answer]);
			autoNow = answer;
		}
		
	}
	var autoComplete = {};
	var autoNow = "";
	var answerEl = document.getElementById('inline-math');
	answerEl.addEventListener('keydown',answerDown);
	answerEl.addEventListener('input',answerChange);
	
	function plotChange(evt) {
		var left = -10;
		var right = 10;
		var spread = 20;
		var bottom = -10;
		var top = 10;
		if (evt){
			spread = evt.target.value;
			left = -.5*spread;
			right = .5*spread;
		}
		else if (document.getElementById("domainSlider")){
			spread = document.getElementById("domainSlider").value;
			left = -.5*spread;
			right = .5*spread;
		}
		var input = document.getElementById("inline-graph").value;
		myWorker.postMessage(["plot",input,left,right,bottom,top,spread]);
		
	}
	function rulesChange(){
		var ruleText = document.getElementById("inline-rules").value;
		console.log(ruleText);
		myWorker.postMessage(["rules","identities",ruleText]);
	}
  </script>
</body>

</html>